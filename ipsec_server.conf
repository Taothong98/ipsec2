# /etc/ipsec.conf - strongSwan IPsec configuration file (Server - Remote Access)

config setup
    # Enable detailed logging for debugging
    charondebug="ike 2, knl 2, cfg 2, net 2, esp 2, dmn 2, mgr 2"
    # Ensure connections are unique if multiple clients have the same ID (less common with PSK)
    uniqueids=no

conn %default
    # Default settings for connections below
    keyexchange=ikev2
    fragmentation=yes
    forceencaps=yes      # Force NAT-T for better compatibility

    # Lifetime settings (adjust as needed)
    ikelifetime=60m
    keylife=20m
    rekeymargin=3m
    keyingtries=%forever

    # Strong encryption proposals (modern defaults)
    ike=chacha20poly1305-sha512-curve25519-prfsha512,aes256gcm16-sha384-modp2048!
    esp=chacha20poly1305-sha512,aes256gcm16-sha384!

# --- Connection definition for Remote Access Clients ---
conn ikev2-remote-access
    auto=add             # Load this connection automatically

    # --- Server Settings (Left) ---
    left=%any            # Listen on all interfaces
    # ✅ Server's ID - Changed to match the IP address expected by the client
    leftid=@172.30.30.100
    leftsubnet=0.0.0.0/0 # Allow server to route client traffic anywhere
    leftauth=psk         # Server authenticates itself using PSK

    # --- Client Settings (Right) ---
    right=%any           # Accept connections from any client IP
    rightid=%any         # Accept connections from any client ID
    # ✅ Assign virtual IPs from this pool to clients
    rightsourceip=10.10.10.0/24 # <-- ⚠️ Ensure this matches VPN_SUBNET in entrypoint
    rightdns=8.8.8.8,1.1.1.1 # Push DNS servers to clients
    rightauth=psk        # Expect clients to authenticate using PSK

    # --- Other settings ---
    dpdaction=clear      # Disconnect if peer is unresponsive
    dpddelay=300s
    eap_identity=%identity # Allows clients to send an identity (even with PSK)